import{R as M,r as k}from"./index-76fb7be0.js";import{_ as P,aq as U,ae as C,ba as S,bb as x,af as A,K as b,bc as G,v as d,J as g,x as v,bd as q}from"./SynapseClient-9f95ca1a.js";import{u as O}from"./useMutation-93672772.js";import{u as _}from"./useInfiniteQuery-63511019.js";import"./getEndpoint-ac94413e.js";import"./OrientationBanner-1c6f5b11.js";import"./jsx-runtime-9dc53467.js";import{i as I}from"./isEqualWith-010efd83.js";import{a as w}from"./isArray-5e3f9107.js";import{i as T}from"./_getTag-0896febb.js";import{i as F,o as R,p as J,a as L}from"./pick-66a3459f.js";import{g as D}from"./InfiniteQueryUtils-54ae7e6b.js";var H=function(e){P(s,e);function s(r,n){var t;return t=e.call(this)||this,t.client=r,t.queries=[],t.result=[],t.observers=[],t.observersMap={},n&&t.setQueries(n),t}var u=s.prototype;return u.onSubscribe=function(){var n=this;this.listeners.length===1&&this.observers.forEach(function(t){t.subscribe(function(a){n.onUpdate(t,a)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(n){n.destroy()})},u.setQueries=function(n,t){this.queries=n,this.updateObservers(t)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(n){return this.findMatchingObservers(n).map(function(t){return t.observer.getOptimisticResult(t.defaultedQueryOptions)})},u.findMatchingObservers=function(n){var t=this,a=this.observers,c=n.map(function(y){return t.client.defaultQueryObserverOptions(y)}),f=c.flatMap(function(y){var h=a.find(function(E){return E.options.queryHash===y.queryHash});return h!=null?[{defaultedQueryOptions:y,observer:h}]:[]}),i=f.map(function(y){return y.defaultedQueryOptions.queryHash}),o=c.filter(function(y){return!i.includes(y.queryHash)}),m=a.filter(function(y){return!f.some(function(h){return h.observer===y})}),l=o.map(function(y,h){if(y.keepPreviousData){var E=m[h];if(E!==void 0)return{defaultedQueryOptions:y,observer:E}}return{defaultedQueryOptions:y,observer:t.getObserver(y)}}),p=function(h,E){return c.indexOf(h.defaultedQueryOptions)-c.indexOf(E.defaultedQueryOptions)};return f.concat(l).sort(p)},u.getObserver=function(n){var t=this.client.defaultQueryObserverOptions(n),a=this.observersMap[t.queryHash];return a??new U(this.client,t)},u.updateObservers=function(n){var t=this;C.batch(function(){var a=t.observers,c=t.findMatchingObservers(t.queries);c.forEach(function(l){return l.observer.setOptions(l.defaultedQueryOptions,n)});var f=c.map(function(l){return l.observer}),i=Object.fromEntries(f.map(function(l){return[l.options.queryHash,l]})),o=f.map(function(l){return l.getCurrentResult()}),m=f.some(function(l,p){return l!==a[p]});a.length===f.length&&!m||(t.observers=f,t.observersMap=i,t.result=o,t.hasListeners()&&(S(a,f).forEach(function(l){l.destroy()}),S(f,a).forEach(function(l){l.subscribe(function(p){t.onUpdate(l,p)})}),t.notify()))})},u.onUpdate=function(n,t){var a=this.observers.indexOf(n);a!==-1&&(this.result=x(this.result,a,t),this.notify())},u.notify=function(){var n=this;C.batch(function(){n.listeners.forEach(function(t){t(n.result)})})},s}(A);function V(e){var s=M.useRef(!1),u=M.useState(0),r=u[1],n=b(),t=k.useMemo(function(){return e.map(function(i){var o=n.defaultQueryObserverOptions(i);return o.optimisticResults=!0,o})},[e,n]),a=M.useState(function(){return new H(n,t)}),c=a[0],f=c.getOptimisticResult(t);return M.useEffect(function(){s.current=!0;var i=c.subscribe(C.batchCalls(function(){s.current&&r(function(o){return o+1})}));return function(){s.current=!1,i()}},[c]),M.useEffect(function(){c.setQueries(t,{listeners:!1})},[t,c]),f}const K=(e,s)=>{if(!(w(e)||w(s))&&!(!T(e)||!T(s))&&!(!F(e,void 0)&&!F(s,void 0)))return I(R(e,u=>u===void 0),R(s,u=>u===void 0),K)};function B(e,s){return I(e,s,K)}function $(e,s){const u=new Set;for(const r of e)u.add(r.id);for(const r of s)if(r.id!=null&&!u.has(r.id))throw new Error(`Proposed schema contains a new column model with ID ${r.id} that is not in the old schema.`)}async function j(e,s,u,r){$(u,r);const n=new Map;for(const i of u)n.set(i.id,i);let t=[];for(const i of r){const o={...i};if(o.id!=null){const m=n.get(o.id);m!=null&&!B(m,o)&&delete o.id}t.push(o)}const a=(await G(e,t)).list,c=[],f=new Set;for(let i=0;i<r.length;i++){const o=r[i].id??null,m=a[i].id;o!=null&&f.add(o),f.add(m),o!=null&&o!==m?c.push({oldColumnId:o,newColumnId:m}):o==null&&c.push({oldColumnId:null,newColumnId:m})}for(const i of u){const o=i.id;f.has(o)||c.push({oldColumnId:o,newColumnId:null})}return{concreteType:"org.sagebionetworks.repo.model.table.TableUpdateTransactionRequest",entityId:s,changes:[{concreteType:"org.sagebionetworks.repo.model.table.TableSchemaChangeRequest",entityId:s,changes:c,orderedColumnIds:a.map(i=>i.id)}]}}function Q(e,s,u){return e.invalidateQueries(s.getEntityQueryKey(u))}function ce(e,s,u){const{accessToken:r,keyFactory:n}=d();return g(n.getEntityVersionQueryKey(e,s),()=>v.getEntity(r,e,s==null?void 0:s.toString()),u)}function oe(e,s){const{accessToken:u,keyFactory:r}=d(),n=e.map(i=>i.id).join(),t=k.useMemo(()=>e.map(i=>({queryKey:r.getEntityVersionQueryKey(i.id,i.versionNumber),queryFn:()=>v.getEntity(u,i.id,i.versionNumber)})),[n]),a=V(t),c=a.some(i=>i.isLoading),f=a.filter(i=>i.data!==void 0).map(i=>i.data);return k.useMemo(()=>(!c&&(s!=null&&s.onSuccess)&&s.onSuccess(f),{isLoading:c,data:f}),[c,n])}function fe(e){const s=b(),{accessToken:u,keyFactory:r}=d();return O(n=>v.createEntity(n,u),{onSuccess:async(n,t,a)=>{await Q(s,r,n.id),s.setQueryData(r.getEntityQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function le(e){const s=b(),{accessToken:u,keyFactory:r}=d();return O(n=>v.updateEntity(n,u),{...e,onSuccess:async(n,t,a)=>{await Q(s,r,n.id),s.setQueryData(r.getEntityQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function ye(e){const s=b(),{accessToken:u,keyFactory:r}=d();return O(n=>v.deleteEntity(u,n),{...e,onSuccess:async(n,t,a)=>{await Q(s,r,t),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function de(e,s){const{accessToken:r,keyFactory:n}=d();return _(n.getEntityVersionsQueryKey(e),async t=>await v.getEntityVersions(e,r,t.pageParam,200),{...s,getNextPageParam:D})}function W(e){return J(e,q[e.concreteType])}function z(e){return L(e,q[e.concreteType])}function ve(e,s,u){const{accessToken:r,keyFactory:n}=d(),t=g(n.getEntityJsonQueryKey(e,s),()=>v.getEntityJson(e,s,r),u),a=k.useMemo(()=>(t==null?void 0:t.data)==null?void 0:W(t.data),[t.data]),c=k.useMemo(()=>(t==null?void 0:t.data)==null?void 0:z(t.data),[t.data]);return{...t,entityMetadata:a,annotations:c}}function me(e){const s=b(),{accessToken:u,keyFactory:r}=d();return O(n=>{const t=n.id;return v.updateEntityJson(t,n,u)},{...e,onSuccess:async(n,t,a)=>{const c=n.id;await Q(s,r,c),s.setQueryData(r.getEntityJsonQueryKey(c,!1),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function he(e,s){const{accessToken:u,keyFactory:r}=d();return g(r.getEntityPathQueryKey(e),()=>v.getEntityPath(e,u),s)}function be(e,s){const{accessToken:u,keyFactory:r}=d();return g(r.getEntityPathQueryKey(e),()=>v.getEntityACL(e,u),s)}function ge(e,s){const{accessToken:u,keyFactory:r}=d();return g(r.getEntityAliasQueryKey(e),()=>v.getEntityAlias(e,u),s)}function Ee(e,s,u){const{accessToken:r,keyFactory:n}=d();return g(n.getEntityEvaluationsQueryKey(e),()=>v.getAllEntityEvaluations(e,s,r),u)}function Oe(e,s){const{accessToken:u,keyFactory:r}=d();return g(r.getEntityAliasQueryKey(e),()=>v.getEntityPermissions(e,u),s)}function Qe(e){const s=b(),{accessToken:u,keyFactory:r}=d();return O(n=>v.updateEntityACL(n,u),{...e,onSuccess:async(n,t,a)=>{await Q(s,r,n.id),s.setQueryData(r.getEntityACLQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function pe(e){const s=b(),{accessToken:u,keyFactory:r}=d();return O(async n=>{const t=await j(u,n.entityId,n.originalColumnModels,n.newColumnModels);return v.updateTable(t,u)},{...e,onSuccess:async(n,t,a)=>{await Q(s,r,t.entityId),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}export{pe as a,he as b,le as c,ve as d,fe as e,oe as f,Ee as g,Qe as h,Q as i,ge as j,be as k,Oe as l,me as m,ye as n,de as o,ce as u};
//# sourceMappingURL=useEntity-9beda7be.js.map
