import{r as _,R as v}from"./index-8db94870.js";import{x as Y,y as ce,j as pe,z as N,C as me}from"./SynapseConstants-935f39ee.js";import{w}from"./SynapseClient-b4c2fe2f.js";import{u as $}from"./useMutation-7233ef1a.js";import{g as ee,B as te}from"./getEndpoint-ac94413e.js";import{j as l,a as S,F as j}from"./jsx-runtime-095bf462.js";import{F as ge}from"./FullWidthAlert-1b1b4f63.js";import{s as fe}from"./styled-a48939ef.js";import{T as Oe}from"./TextField-87ab8354.js";import{B as D}from"./Box-f53d00dc.js";import{B as k}from"./Button-3631c64e.js";import{T as b}from"./TextField-3c08f09a.js";import{L as V}from"./Link-9ced689e.js";import{L as z}from"./LoginMethodButton-7079c30d.js";import{I as Ee}from"./IconSvg-85f98416.js";import{I as he}from"./IconButton-76e05815.js";function Ye(t,o){const[a,r]=_.useState("CHOOSE_AUTH_METHOD"),[p,n]=_.useState(),[d,c]=_.useState(),[g,m]=_.useState();_.useEffect(()=>{const i=new URL(window.location.href.replaceAll("#","/")),{searchParams:f}=i;if(f){const E=f.get("userId"),R=f.get("twoFaToken");E&&R&&(c(parseInt(E,10)),m(R),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(a)||r("VERIFICATION_CODE"))}},[a]),_.useEffect(()=>{o&&(m(o.twoFaToken),c(o.userId),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(a)||r("VERIFICATION_CODE"))},[o]),_.useEffect(()=>{n(void 0)},[a]);async function C(i){await w.setAccessTokenCookie(i.accessToken),localStorage.setItem(Y,i.authenticationReceipt),r("LOGGED_IN"),t&&t()}const{mutate:O,isLoading:y}=$(({username:i,password:f,authenticationReceipt:E})=>w.login(i,f,E),{onError:i=>{n(i.reason)},onSuccess:async i=>{i&&("errorCode"in i?(r("VERIFICATION_CODE"),m(i.twoFaToken),c(i.userId)):await C(i))}}),{mutate:T,isLoading:L}=$(w.loginWith2fa,{onError:i=>{n(i.reason),(i.reason.includes("The provided twoFaToken is invalid")||i.reason.includes("Token has expired"))&&(console.warn(i),n("Something went wrong. Refresh the page and try again."),window.location.href.includes("twoFaToken")&&window.history.replaceState({},document.title,window.location.href.replaceAll(/(twoFaToken|userId)=[^&]*&?/g,"")))},onSuccess:C});return{step:a,onStepChange:r,submitUsernameAndPassword:(i,f)=>{n(void 0);const E=localStorage.getItem(Y);O({username:i,password:f,authenticationReceipt:E})},submitOneTimePassword:(i,f=a==="RECOVERY_CODE"?"RECOVERY_CODE":"TOTP")=>{if(n(void 0),g==null||d==null){n("You did not first log in with your password or a third-party identity provider.");return}T({userId:d,twoFaToken:g,otpCode:i,otpType:f})},errorMessage:p,isLoading:y||L}}const _e=fe(Oe)`
  input {
    text-align: center;
  }
`,Ce={TextFieldStyled:_e},ye=t=>l(Ce.TextFieldStyled,{...t}),P={left:"ArrowLeft",right:"ArrowRight",backspace:"Backspace"};function Ae(t,o){return t<=0?[]:Array.from({length:t},o)}function Re(t,o,a){return t.map((r,p)=>o===p?a:r)}function K(t){return t.join("")}function J(t,o){return[...t,o]}function Se(t,o,a){return t.reduce((r,p,n)=>{const{characters:d,restArrayMerged:c}=r;if(n<a)return{restArrayMerged:c,characters:J(d,p)};const[g,...m]=c;return{restArrayMerged:m,characters:J(d,g||"")}},{restArrayMerged:o,characters:[]}).characters}function Te(t){return t.split("")}const re=v.forwardRef((t,o)=>{const{value:a,length:r,autoFocus:p,onChange:n,TextFieldsProps:d,onComplete:c,validateChar:g,className:m,...C}=t,{onPaste:O,onFocus:y,onKeyDown:T,className:L,...B}=d||{},A=Ae(r,(e,u)=>({character:a[u]||"",inputRef:v.createRef()})),i=e=>A.findIndex(({inputRef:u})=>u.current===e),f=()=>A.map(({character:e})=>e),E=(e,u)=>{const s=Re(f(),e,u);return K(s)},R=e=>{var u,s;(s=(u=A[e])==null?void 0:u.inputRef.current)==null||s.focus()},I=e=>{var u,s;(s=(u=A[e])==null?void 0:u.inputRef.current)==null||s.select()},U=e=>{e+1!==r&&(A[e+1].character?I(e+1):R(e+1))},ne=e=>{e>0&&I(e-1)},oe=e=>{const u=e.target.value[0]||"",s=i(e.target);if(typeof g=="function"&&!g(u,s))return;const h=E(s,u);n==null||n(h),h.length===r&&(c==null||c(h)),u!==""?h.length<r?U(h.length-1):U(s):h[s]?I(s):ne(s)},ae=e=>{e.preventDefault(),e.target.select(),y==null||y(e)},ie=e=>{const u=e.target,s=i(u);u.value===e.key?(e.preventDefault(),U(s)):!u.value&&P.backspace===e.key||P.left===e.key?(e.preventDefault(),I(s-1)):P.right===e.key&&(e.preventDefault(),I(s+1)),T==null||T(e)},se=e=>{e.preventDefault();const u=e.target,s=e.clipboardData.getData("text/plain"),h=i(u),ue=f(),q=Se(ue,Te(s),h),W=q.findIndex((le,de)=>de>h&&le===""),F=K(q);if(n==null||n(F),F.length===r){c==null||c(F),R(r-1);return}W!==-1&&R(W),O==null||O(e)};return l(D,{display:"flex",gap:"20px",alignItems:"center",ref:o,className:`MuiOtpInput-Box ${m||""}`,...C,children:A.map(({character:e,inputRef:u},s)=>l(ye,{autoFocus:p?s===0:!1,autoComplete:"one-time-code",value:e,inputRef:u,className:`MuiOtpInput-TextField MuiOtpInput-TextField-${s+1} ${L||""}`,onPaste:se,onFocus:ae,onChange:oe,onKeyDown:ie,...B},s))})});re.defaultProps={value:"",length:4,autoFocus:!1,validateChar:()=>!0,onChange:()=>{},onComplete:()=>{},TextFieldsProps:{}};const Q=6,Ie=["0","1","2","3","4","5","6","7","8","9"];function M(t){const{onSubmit:o,isLoading:a}=t,[r,p]=v.useState("");return S(D,{children:[l(re,{autoFocus:!0,length:Q,value:r,onChange:p,onComplete:o,validateChar:n=>Ie.includes(n)||n==="",gap:"2px",sx:{".MuiInputBase-root":{paddingLeft:"5px",paddingRight:"5px"},".MuiFormControl-root:first-of-type > .MuiInputBase-root":{borderTopRightRadius:0,borderBottomRightRadius:0},".MuiFormControl-root:last-of-type > .MuiInputBase-root":{borderTopLeftRadius:0,borderBottomLeftRadius:0},".MuiFormControl-root:not(:first-of-type):not(:last-of-type) > .MuiInputBase-root":{borderRadius:0}}}),l(k,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:r.length!==Q||a,onClick:n=>{n.preventDefault(),o(r)},children:a?"Verifying...":"Submit"})]})}try{M.displayName="TOTPForm",M.__docgenInfo={description:"",displayName:"TOTPForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function x(t){const{resetPasswordUrl:o=`${ee(te.PORTAL_ENDPOINT)}#!PasswordReset:0`,onSubmit:a,isLoading:r}=t,[p,n]=_.useState(""),[d,c]=_.useState("");function g(m){m.preventDefault(),a(p,d)}return S("form",{onSubmit:m=>{g(m)},children:[l(b,{required:!0,fullWidth:!0,autoFocus:!0,autoComplete:"username",label:"Username or Email Address",id:"username",type:"text",value:p,onChange:m=>n(m.target.value)}),l(b,{required:!0,fullWidth:!0,autoComplete:"current-password",label:"Password",id:"current-password",type:"password",value:d,onChange:m=>c(m.target.value)}),l(V,{href:o,children:"Forgot password?"}),l(k,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",disabled:r,sx:{height:"50px",mt:4,mb:2},children:r?"Logging you in...":"Sign in"})]})}try{x.displayName="UsernamePasswordForm",x.__docgenInfo={description:"",displayName:"UsernamePasswordForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(username: string, password: string) => void"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function H(t){const{onBeginOAuthSignIn:o,ssoRedirectUrl:a,onSelectUsernameAndPassword:r}=t;function p(n){o&&o(),n.preventDefault();const d=a?`${a}${N.GOOGLE}`:`${w.getRootURL()}?provider=${N.GOOGLE}`;w.oAuthUrlRequest(N.GOOGLE,d).then(c=>{window.location=c.authorizationUrl}).catch(c=>{console.log("Error on oAuth url ",c)})}return S(D,{children:[l(z,{loginMethod:ce,iconName:"google24",onClick:p}),l(z,{loginMethod:pe,iconName:"email",onClick:r})]})}try{H.displayName="AuthenticationMethodSelection",H.__docgenInfo={description:`To support Google SSO in your portal, you must add your domain to the Authorized Redirect URIs for Synapse authentication.
This can be done by visiting https://sagebionetworks.jira.com/servicedesk/customer/portal/9 to set up a collaboration.
Synapse engineers must add your redirect URL in the Google API console found at https://console.cloud.google.com/ for this functionality to work.`,displayName:"AuthenticationMethodSelection",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},onSelectUsernameAndPassword:{defaultValue:null,description:"",name:"onSelectUsernameAndPassword",required:!0,type:{name:"() => void"}}}}}catch{}const we=19;function G(t){const{onSubmit:o,isLoading:a}=t,[r,p]=v.useState("");return S(D,{children:[l(b,{placeholder:"Enter backup code",value:r,onChange:n=>{const d=n.target.value.toLowerCase().replace(/[^a-z0-9-]/gi,"");p(d)}}),l(k,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:r.length!==we||a,onClick:n=>{n.preventDefault(),o(r)},children:a?"Verifying...":"Submit"})]})}try{G.displayName="RecoveryCodeForm",G.__docgenInfo={description:"",displayName:"RecoveryCodeForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function X(t){const{ssoRedirectUrl:o,registerAccountUrl:a=`${ee(te.PORTAL_ENDPOINT)}#!RegisterAccount:0`,resetPasswordUrl:r,onBeginOAuthSignIn:p,onStepChange:n,step:d,submitUsernameAndPassword:c,submitOneTimePassword:g,errorMessage:m,isLoading:C}=t;return S(j,{children:[d=="CHOOSE_AUTH_METHOD"&&l(H,{onSelectUsernameAndPassword:()=>n("USERNAME_PASSWORD"),onBeginOAuthSignIn:p,ssoRedirectUrl:o}),d==="USERNAME_PASSWORD"&&l(x,{isLoading:C,resetPasswordUrl:r,onSubmit:(O,y)=>{c(O,y)}}),d==="VERIFICATION_CODE"&&S(j,{children:[l(M,{isLoading:C,onSubmit:O=>{g(O,"TOTP")}}),l(V,{align:"center",color:"grey.700",sx:{display:"block",mx:"auto"},onClick:()=>n("RECOVERY_CODE"),children:"Use a backup code instead"})]}),d==="RECOVERY_CODE"&&l(G,{isLoading:C,onSubmit:O=>{g(O,"RECOVERY_CODE")}}),(d==="CHOOSE_AUTH_METHOD"||d==="USERNAME_PASSWORD")&&l(D,{sx:{display:"flex",justifyContent:"center",mt:"10px"},children:l(V,{href:a,align:"center",children:"Don't have an account? Create one now"})}),m&&l(ge,{variant:"warning",isGlobal:!1,description:m})]})}try{X.displayName="LoginForm",X.__docgenInfo={description:"",displayName:"LoginForm",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},registerAccountUrl:{defaultValue:null,description:"",name:"registerAccountUrl",required:!1,type:{name:"string"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},twoFactorAuthenticationRequired:{defaultValue:null,description:"",name:"twoFactorAuthenticationRequired",required:!1,type:{name:"TwoFactorAuthErrorResponse"}},submitUsernameAndPassword:{defaultValue:null,description:"",name:"submitUsernameAndPassword",required:!0,type:{name:"(username: string, password: string) => void"}},submitOneTimePassword:{defaultValue:null,description:"",name:"submitOneTimePassword",required:!0,type:{name:"(code: string, otpType?: TwoFactorAuthOtpType | undefined) => void"}},errorMessage:{defaultValue:null,description:"",name:"errorMessage",required:!0,type:{name:"string | undefined"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function De(t){switch(t){case"CHOOSE_AUTH_METHOD":return"CHOOSE_AUTH_METHOD";case"USERNAME_PASSWORD":return"CHOOSE_AUTH_METHOD";case"VERIFICATION_CODE":return"CHOOSE_AUTH_METHOD";case"RECOVERY_CODE":return"VERIFICATION_CODE";case"LOGGED_IN":return"LOGGED_IN"}}function Z(t){const{step:o,onStepChange:a,sx:r}=t;return o==="USERNAME_PASSWORD"||o==="VERIFICATION_CODE"||o==="RECOVERY_CODE"?l(he,{className:me,type:"button",onClick:()=>{a(De(o))},sx:r,children:l(Ee,{icon:"arrowBack",wrap:!1,sx:{height:"24px",width:"24px"}})}):null}try{Z.displayName="LoginFlowBackButton",Z.__docgenInfo={description:"",displayName:"LoginFlowBackButton",props:{step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},sx:{defaultValue:null,description:"",name:"sx",required:!1,type:{name:"SxProps"}}}}}catch{}export{Z as L,X as a,Ye as u};
//# sourceMappingURL=LoginFlowBackButton-18ccc209.js.map
