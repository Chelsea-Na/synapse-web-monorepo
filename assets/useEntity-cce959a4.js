import{R as Q,r as p}from"./index-8db94870.js";import{a3 as T,aC as R,au as C,bs as w,bt as F,av as q,Q as O,bu as K,u as d,L as m,t as v,bv as S}from"./SynapseClient-263d1708.js";import{u as k}from"./useMutation-2fd2f657.js";import{u as I}from"./useInfiniteQuery-13409d0d.js";import"./getEndpoint-ac94413e.js";import"./OrientationBanner-6f1c542d.js";import"./jsx-runtime-095bf462.js";import{i as U}from"./isEqual-ac67b0a5.js";import{p as L,o as P}from"./pick-534cade1.js";var x=function(t){T(s,t);function s(r,n){var e;return e=t.call(this)||this,e.client=r,e.queries=[],e.result=[],e.observers=[],e.observersMap={},n&&e.setQueries(n),e}var u=s.prototype;return u.onSubscribe=function(){var n=this;this.listeners.length===1&&this.observers.forEach(function(e){e.subscribe(function(a){n.onUpdate(e,a)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(n){n.destroy()})},u.setQueries=function(n,e){this.queries=n,this.updateObservers(e)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(n){return this.findMatchingObservers(n).map(function(e){return e.observer.getOptimisticResult(e.defaultedQueryOptions)})},u.findMatchingObservers=function(n){var e=this,a=this.observers,c=n.map(function(l){return e.client.defaultQueryObserverOptions(l)}),f=c.flatMap(function(l){var b=a.find(function(g){return g.options.queryHash===l.queryHash});return b!=null?[{defaultedQueryOptions:l,observer:b}]:[]}),i=f.map(function(l){return l.defaultedQueryOptions.queryHash}),o=c.filter(function(l){return!i.includes(l.queryHash)}),h=a.filter(function(l){return!f.some(function(b){return b.observer===l})}),y=o.map(function(l,b){if(l.keepPreviousData){var g=h[b];if(g!==void 0)return{defaultedQueryOptions:l,observer:g}}return{defaultedQueryOptions:l,observer:e.getObserver(l)}}),E=function(b,g){return c.indexOf(b.defaultedQueryOptions)-c.indexOf(g.defaultedQueryOptions)};return f.concat(y).sort(E)},u.getObserver=function(n){var e=this.client.defaultQueryObserverOptions(n),a=this.observersMap[e.queryHash];return a??new R(this.client,e)},u.updateObservers=function(n){var e=this;C.batch(function(){var a=e.observers,c=e.findMatchingObservers(e.queries);c.forEach(function(y){return y.observer.setOptions(y.defaultedQueryOptions,n)});var f=c.map(function(y){return y.observer}),i=Object.fromEntries(f.map(function(y){return[y.options.queryHash,y]})),o=f.map(function(y){return y.getCurrentResult()}),h=f.some(function(y,E){return y!==a[E]});a.length===f.length&&!h||(e.observers=f,e.observersMap=i,e.result=o,e.hasListeners()&&(w(a,f).forEach(function(y){y.destroy()}),w(f,a).forEach(function(y){y.subscribe(function(E){e.onUpdate(y,E)})}),e.notify()))})},u.onUpdate=function(n,e){var a=this.observers.indexOf(n);a!==-1&&(this.result=F(this.result,a,e),this.notify())},u.notify=function(){var n=this;C.batch(function(){n.listeners.forEach(function(e){e(n.result)})})},s}(q);function G(t){var s=Q.useRef(!1),u=Q.useState(0),r=u[1],n=O(),e=p.useMemo(function(){return t.map(function(i){var o=n.defaultQueryObserverOptions(i);return o.optimisticResults=!0,o})},[t,n]),a=Q.useState(function(){return new x(n,e)}),c=a[0],f=c.getOptimisticResult(e);return Q.useEffect(function(){s.current=!0;var i=c.subscribe(C.batchCalls(function(){s.current&&r(function(o){return o+1})}));return function(){s.current=!1,i()}},[c]),Q.useEffect(function(){c.setQueries(e,{listeners:!1})},[e,c]),f}async function A(t,s,u,r){const n=new Map;for(const i of u)n.set(i.id,i);let e=[];for(const i of r){const o={...i};if(o.id!=null){const h=n.get(o.id);h!=null&&!U(h,o)&&delete o.id}e.push(o)}const a=(await K(t,e)).list,c=[],f=new Set;for(let i=0;i<r.length;i++){const o=r[i].id??null,h=a[i].id??null;f.add(o),f.add(h),o!==h&&c.push({oldColumnId:o,newColumnId:h})}for(const i of u){const o=i.id;f.has(o)||c.push({oldColumnId:o,newColumnId:null})}return{concreteType:"org.sagebionetworks.repo.model.table.TableUpdateTransactionRequest",entityId:s,changes:[{concreteType:"org.sagebionetworks.repo.model.table.TableSchemaChangeRequest",entityId:s,changes:c,orderedColumnIds:a.map(i=>i.id)}]}}function M(t,s,u){return t.invalidateQueries(s.getEntityQueryKey(u))}function Y(t,s,u){const{accessToken:r,keyFactory:n}=d();return m(n.getEntityVersionQueryKey(t,s),()=>v.getEntity(r,t,s==null?void 0:s.toString()),u)}function Z(t,s){const{accessToken:u,keyFactory:r}=d(),n=t.map(i=>i.id).join(),e=p.useMemo(()=>t.map(i=>({queryKey:r.getEntityVersionQueryKey(i.id,i.versionNumber),queryFn:()=>v.getEntity(u,i.id,i.versionNumber)})),[n]),a=G(e),c=a.some(i=>i.isLoading),f=a.filter(i=>i.data!==void 0).map(i=>i.data);return p.useMemo(()=>(!c&&(s!=null&&s.onSuccess)&&s.onSuccess(f),{isLoading:c,data:f}),[c,n])}function N(t){const s=O(),{accessToken:u,keyFactory:r}=d();return k(n=>v.updateEntity(n,u),{...t,onSuccess:async(n,e,a)=>{await M(s,r,n.id),s.setQueryData(r.getEntityQueryKey(n.id),n),t!=null&&t.onSuccess&&await t.onSuccess(n,e,a)}})}function ee(t){const s=O(),{accessToken:u,keyFactory:r}=d();return k(n=>v.deleteEntity(u,n),{...t,onSuccess:async(n,e,a)=>{await M(s,r,e),t!=null&&t.onSuccess&&await t.onSuccess(n,e,a)}})}function te(t,s){const{accessToken:r,keyFactory:n}=d();return I(n.getEntityVersionsQueryKey(t),async e=>await v.getEntityVersions(t,r,e.pageParam,200),{...s,getNextPageParam:(e,a)=>{if(e.results.length>0)return a.length*200}})}function _(t){return L(t,S[t.concreteType])}function J(t){return P(t,S[t.concreteType])}function ne(t,s,u){const{accessToken:r,keyFactory:n}=d(),e=m(n.getEntityJsonQueryKey(t,s),()=>v.getEntityJson(t,s,r),u),a=p.useMemo(()=>(e==null?void 0:e.data)==null?void 0:_(e.data),[e.data]),c=p.useMemo(()=>(e==null?void 0:e.data)==null?void 0:J(e.data),[e.data]);return{...e,entityMetadata:a,annotations:c}}function se(t){const s=O(),{accessToken:u,keyFactory:r}=d();return k(n=>{const e=n.id;return v.updateEntityJson(e,n,u)},{...t,onSuccess:async(n,e,a)=>{const c=n.id;await M(s,r,c),s.setQueryData(r.getEntityJsonQueryKey(c,!1),n),t!=null&&t.onSuccess&&await t.onSuccess(n,e,a)}})}function re(t,s){const{accessToken:u,keyFactory:r}=d();return m(r.getEntityPathQueryKey(t),()=>v.getEntityPath(t,u),s)}function ue(t,s){const{accessToken:u,keyFactory:r}=d();return m(r.getEntityPathQueryKey(t),()=>v.getEntityACL(t,u),s)}function ae(t,s){const{accessToken:u,keyFactory:r}=d();return m(r.getEntityAliasQueryKey(t),()=>v.getEntityAlias(t,u),s)}function ie(t,s,u){const{accessToken:r,keyFactory:n}=d();return m(n.getEntityEvaluationsQueryKey(t),()=>v.getAllEntityEvaluations(t,s,r),u)}function ce(t,s){const{accessToken:u,keyFactory:r}=d();return m(r.getEntityAliasQueryKey(t),()=>v.getEntityPermissions(t,u),s)}function oe(t){const s=O(),{accessToken:u,keyFactory:r}=d();return k(n=>v.updateEntityACL(n,u),{...t,onSuccess:async(n,e,a)=>{await M(s,r,n.id),s.setQueryData(r.getEntityACLQueryKey(n.id),n),t!=null&&t.onSuccess&&await t.onSuccess(n,e,a)}})}function fe(t){const s=O(),{accessToken:u,keyFactory:r}=d();return k(async n=>{const e=await A(u,n.entityId,n.originalColumnModels,n.newColumnModels);return v.updateTable(e,u)},{...t,onSuccess:async(n,e,a)=>{await M(s,r,e.entityId),t!=null&&t.onSuccess&&await t.onSuccess(n,e,a)}})}export{ne as a,re as b,N as c,Z as d,ie as e,oe as f,ae as g,ue as h,M as i,ce as j,fe as k,se as l,ee as m,te as n,Y as u};
//# sourceMappingURL=useEntity-cce959a4.js.map
