import{R as Q,r as m}from"./index-8db94870.js";import{a3 as w,aF as C,ax as M,bn as T,bo as R,ay as K,Q as O,u as l,L as b,t as v,bp as F}from"./SynapseClient-db82e28e.js";import{u as p}from"./useMutation-a0de2a32.js";import{u as q}from"./useInfiniteQuery-fe26833d.js";import"./getEndpoint-ac94413e.js";import"./OrientationBanner-53051860.js";import{p as x,o as L}from"./pick-3f1e07b9.js";var P=function(t){w(n,t);function n(s,r){var e;return e=t.call(this)||this,e.client=s,e.queries=[],e.result=[],e.observers=[],e.observersMap={},r&&e.setQueries(r),e}var u=n.prototype;return u.onSubscribe=function(){var r=this;this.listeners.length===1&&this.observers.forEach(function(e){e.subscribe(function(a){r.onUpdate(e,a)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(r){r.destroy()})},u.setQueries=function(r,e){this.queries=r,this.updateObservers(e)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(r){return this.findMatchingObservers(r).map(function(e){return e.observer.getOptimisticResult(e.defaultedQueryOptions)})},u.findMatchingObservers=function(r){var e=this,a=this.observers,i=r.map(function(y){return e.client.defaultQueryObserverOptions(y)}),f=i.flatMap(function(y){var h=a.find(function(g){return g.options.queryHash===y.queryHash});return h!=null?[{defaultedQueryOptions:y,observer:h}]:[]}),c=f.map(function(y){return y.defaultedQueryOptions.queryHash}),d=i.filter(function(y){return!c.includes(y.queryHash)}),S=a.filter(function(y){return!f.some(function(h){return h.observer===y})}),o=d.map(function(y,h){if(y.keepPreviousData){var g=S[h];if(g!==void 0)return{defaultedQueryOptions:y,observer:g}}return{defaultedQueryOptions:y,observer:e.getObserver(y)}}),E=function(h,g){return i.indexOf(h.defaultedQueryOptions)-i.indexOf(g.defaultedQueryOptions)};return f.concat(o).sort(E)},u.getObserver=function(r){var e=this.client.defaultQueryObserverOptions(r),a=this.observersMap[e.queryHash];return a??new C(this.client,e)},u.updateObservers=function(r){var e=this;M.batch(function(){var a=e.observers,i=e.findMatchingObservers(e.queries);i.forEach(function(o){return o.observer.setOptions(o.defaultedQueryOptions,r)});var f=i.map(function(o){return o.observer}),c=Object.fromEntries(f.map(function(o){return[o.options.queryHash,o]})),d=f.map(function(o){return o.getCurrentResult()}),S=f.some(function(o,E){return o!==a[E]});a.length===f.length&&!S||(e.observers=f,e.observersMap=c,e.result=d,e.hasListeners()&&(T(a,f).forEach(function(o){o.destroy()}),T(f,a).forEach(function(o){o.subscribe(function(E){e.onUpdate(o,E)})}),e.notify()))})},u.onUpdate=function(r,e){var a=this.observers.indexOf(r);a!==-1&&(this.result=R(this.result,a,e),this.notify())},u.notify=function(){var r=this;M.batch(function(){r.listeners.forEach(function(e){e(r.result)})})},n}(K);function U(t){var n=Q.useRef(!1),u=Q.useState(0),s=u[1],r=O(),e=m.useMemo(function(){return t.map(function(c){var d=r.defaultQueryObserverOptions(c);return d.optimisticResults=!0,d})},[t,r]),a=Q.useState(function(){return new P(r,e)}),i=a[0],f=i.getOptimisticResult(e);return Q.useEffect(function(){n.current=!0;var c=i.subscribe(M.batchCalls(function(){n.current&&s(function(d){return d+1})}));return function(){n.current=!1,c()}},[i]),Q.useEffect(function(){i.setQueries(e,{listeners:!1})},[e,i]),f}function k(t,n,u){return t.invalidateQueries(n.getEntityQueryKey(u))}function $(t,n,u){const{accessToken:s,keyFactory:r}=l();return b(r.getEntityVersionQueryKey(t,n),()=>v.getEntity(s,t,n==null?void 0:n.toString()),u)}function j(t,n){const{accessToken:u,keyFactory:s}=l(),r=t.map(c=>c.id).join(),e=m.useMemo(()=>t.map(c=>({queryKey:s.getEntityVersionQueryKey(c.id,c.versionNumber),queryFn:()=>v.getEntity(u,c.id,c.versionNumber)})),[r]),a=U(e),i=a.some(c=>c.isLoading),f=a.filter(c=>c.data!==void 0).map(c=>c.data);return m.useMemo(()=>(!i&&(n!=null&&n.onSuccess)&&n.onSuccess(f),{isLoading:i,data:f}),[i,r])}function z(t){const n=O(),{accessToken:u,keyFactory:s}=l();return p(r=>v.updateEntity(r,u),{...t,onSuccess:async(r,e,a)=>{await k(n,s,r.id),n.setQueryData(s.getEntityQueryKey(r.id),r),t!=null&&t.onSuccess&&await t.onSuccess(r,e,a)}})}function W(t){const n=O(),{accessToken:u,keyFactory:s}=l();return p(r=>v.deleteEntity(u,r),{...t,onSuccess:async(r,e,a)=>{await k(n,s,e),t!=null&&t.onSuccess&&await t.onSuccess(r,e,a)}})}function X(t,n){const{accessToken:s,keyFactory:r}=l();return q(r.getEntityVersionsQueryKey(t),async e=>await v.getEntityVersions(t,s,e.pageParam,200),{...n,getNextPageParam:(e,a)=>{if(e.results.length>0)return a.length*200}})}function G(t){return x(t,F[t.concreteType])}function A(t){return L(t,F[t.concreteType])}function Y(t,n,u){const{accessToken:s,keyFactory:r}=l(),e=b(r.getEntityJsonQueryKey(t,n),()=>v.getEntityJson(t,n,s),u),a=m.useMemo(()=>(e==null?void 0:e.data)==null?void 0:G(e.data),[e.data]),i=m.useMemo(()=>(e==null?void 0:e.data)==null?void 0:A(e.data),[e.data]);return{...e,entityMetadata:a,annotations:i}}function Z(t){const n=O(),{accessToken:u,keyFactory:s}=l();return p(r=>{const e=r.id;return v.updateEntityJson(e,r,u)},{...t,onSuccess:async(r,e,a)=>{const i=r.id;await k(n,s,i),n.setQueryData(s.getEntityJsonQueryKey(i,!1),r),t!=null&&t.onSuccess&&await t.onSuccess(r,e,a)}})}function N(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(t),()=>v.getEntityPath(t,u),n)}function ee(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(t),()=>v.getEntityACL(t,u),n)}function te(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(t),()=>v.getEntityAlias(t,u),n)}function re(t,n,u){const{accessToken:s,keyFactory:r}=l();return b(r.getEntityEvaluationsQueryKey(t),()=>v.getAllEntityEvaluations(t,n,s),u)}function ne(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(t),()=>v.getEntityPermissions(t,u),n)}function se(t){const n=O(),{accessToken:u,keyFactory:s}=l();return p(r=>v.updateEntityACL(r,u),{...t,onSuccess:async(r,e,a)=>{await k(n,s,r.id),n.setQueryData(s.getEntityACLQueryKey(r.id),r),t!=null&&t.onSuccess&&await t.onSuccess(r,e,a)}})}function ue(t){const n=O(),{accessToken:u,keyFactory:s}=l();return p(r=>v.updateTable(r,u),{...t,onSuccess:async(r,e,a)=>{await k(n,s,e.entityId),t!=null&&t.onSuccess&&await t.onSuccess(r,e,a)}})}export{Y as a,N as b,z as c,j as d,re as e,se as f,te as g,ee as h,k as i,ne as j,ue as k,Z as l,W as m,X as n,$ as u};
//# sourceMappingURL=useEntity-f2ca00fb.js.map
