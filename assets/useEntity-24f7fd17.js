import{R as E,r as m}from"./index-8db94870.js";import{aE as F,aw as M,bm as T,bn as R,ax as C,G as Q,u as l,z as b,n as v,bo as w}from"./SynapseClient-3edb66de.js";import{u as p}from"./useMutation-b7361741.js";import{_ as K}from"./inheritsLoose-c82a83d4.js";import{u as q}from"./useInfiniteQuery-714d9bf5.js";import"./getEndpoint-ac94413e.js";import"./OrientationBanner-9d515953.js";import{p as x,o as G}from"./pick-246c5ef1.js";var P=function(t){K(n,t);function n(s,r){var e;return e=t.call(this)||this,e.client=s,e.queries=[],e.result=[],e.observers=[],e.observersMap={},r&&e.setQueries(r),e}var u=n.prototype;return u.onSubscribe=function(){var r=this;this.listeners.length===1&&this.observers.forEach(function(e){e.subscribe(function(i){r.onUpdate(e,i)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(r){r.destroy()})},u.setQueries=function(r,e){this.queries=r,this.updateObservers(e)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(r){return this.findMatchingObservers(r).map(function(e){return e.observer.getOptimisticResult(e.defaultedQueryOptions)})},u.findMatchingObservers=function(r){var e=this,i=this.observers,a=r.map(function(y){return e.client.defaultQueryObserverOptions(y)}),f=a.flatMap(function(y){var h=i.find(function(g){return g.options.queryHash===y.queryHash});return h!=null?[{defaultedQueryOptions:y,observer:h}]:[]}),c=f.map(function(y){return y.defaultedQueryOptions.queryHash}),d=a.filter(function(y){return!c.includes(y.queryHash)}),S=i.filter(function(y){return!f.some(function(h){return h.observer===y})}),o=d.map(function(y,h){if(y.keepPreviousData){var g=S[h];if(g!==void 0)return{defaultedQueryOptions:y,observer:g}}return{defaultedQueryOptions:y,observer:e.getObserver(y)}}),O=function(h,g){return a.indexOf(h.defaultedQueryOptions)-a.indexOf(g.defaultedQueryOptions)};return f.concat(o).sort(O)},u.getObserver=function(r){var e=this.client.defaultQueryObserverOptions(r),i=this.observersMap[e.queryHash];return i??new F(this.client,e)},u.updateObservers=function(r){var e=this;M.batch(function(){var i=e.observers,a=e.findMatchingObservers(e.queries);a.forEach(function(o){return o.observer.setOptions(o.defaultedQueryOptions,r)});var f=a.map(function(o){return o.observer}),c=Object.fromEntries(f.map(function(o){return[o.options.queryHash,o]})),d=f.map(function(o){return o.getCurrentResult()}),S=f.some(function(o,O){return o!==i[O]});i.length===f.length&&!S||(e.observers=f,e.observersMap=c,e.result=d,e.hasListeners()&&(T(i,f).forEach(function(o){o.destroy()}),T(f,i).forEach(function(o){o.subscribe(function(O){e.onUpdate(o,O)})}),e.notify()))})},u.onUpdate=function(r,e){var i=this.observers.indexOf(r);i!==-1&&(this.result=R(this.result,i,e),this.notify())},u.notify=function(){var r=this;M.batch(function(){r.listeners.forEach(function(e){e(r.result)})})},n}(C);function L(t){var n=E.useRef(!1),u=E.useState(0),s=u[1],r=Q(),e=m.useMemo(function(){return t.map(function(c){var d=r.defaultQueryObserverOptions(c);return d.optimisticResults=!0,d})},[t,r]),i=E.useState(function(){return new P(r,e)}),a=i[0],f=a.getOptimisticResult(e);return E.useEffect(function(){n.current=!0;var c=a.subscribe(M.batchCalls(function(){n.current&&s(function(d){return d+1})}));return function(){n.current=!1,c()}},[a]),E.useEffect(function(){a.setQueries(e,{listeners:!1})},[e,a]),f}function k(t,n,u){return t.invalidateQueries(n.getEntityQueryKey(u))}function z(t,n,u){const{accessToken:s,keyFactory:r}=l();return b(r.getEntityVersionQueryKey(t,n),()=>v.getEntity(s,t,n==null?void 0:n.toString()),u)}function j(t,n){const{accessToken:u,keyFactory:s}=l(),r=t.map(c=>c.id).join(),e=m.useMemo(()=>t.map(c=>({queryKey:s.getEntityVersionQueryKey(c.id,c.versionNumber),queryFn:()=>v.getEntity(u,c.id,c.versionNumber)})),[r]),i=L(e),a=i.some(c=>c.isLoading),f=i.filter(c=>c.data!==void 0).map(c=>c.data);return m.useMemo(()=>(!a&&(n!=null&&n.onSuccess)&&n.onSuccess(f),{isLoading:a,data:f}),[a,r])}function W(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(r=>v.updateEntity(r,u),{...t,onSuccess:async(r,e,i)=>{await k(n,s,r.id),n.setQueryData(s.getEntityQueryKey(r.id),r),t!=null&&t.onSuccess&&await t.onSuccess(r,e,i)}})}function X(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(r=>v.deleteEntity(u,r),{...t,onSuccess:async(r,e,i)=>{await k(n,s,e),t!=null&&t.onSuccess&&await t.onSuccess(r,e,i)}})}function Y(t,n){const{accessToken:s,keyFactory:r}=l();return q(r.getEntityVersionsQueryKey(t),async e=>await v.getEntityVersions(t,s,e.pageParam,200),{...n,getNextPageParam:(e,i)=>{if(e.results.length>0)return i.length*200}})}function U(t){return x(t,w[t.concreteType])}function _(t){return G(t,w[t.concreteType])}function Z(t,n,u){const{accessToken:s,keyFactory:r}=l(),e=b(r.getEntityJsonQueryKey(t,n),()=>v.getEntityJson(t,n,s),u),i=m.useMemo(()=>(e==null?void 0:e.data)==null?void 0:U(e.data),[e.data]),a=m.useMemo(()=>(e==null?void 0:e.data)==null?void 0:_(e.data),[e.data]);return{...e,entityMetadata:i,annotations:a}}function N(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(r=>{const e=r.id;return v.updateEntityJson(e,r,u)},{...t,onSuccess:async(r,e,i)=>{const a=r.id;await k(n,s,a),n.setQueryData(s.getEntityJsonQueryKey(a,!1),r),t!=null&&t.onSuccess&&await t.onSuccess(r,e,i)}})}function ee(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(t),()=>v.getEntityPath(t,u),n)}function te(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(t),()=>v.getEntityACL(t,u),n)}function re(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(t),()=>v.getEntityAlias(t,u),n)}function ne(t,n,u){const{accessToken:s,keyFactory:r}=l();return b(r.getEntityEvaluationsQueryKey(t),()=>v.getAllEntityEvaluations(t,n,s),u)}function se(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(t),()=>v.getEntityPermissions(t,u),n)}function ue(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(r=>v.updateEntityACL(r,u),{...t,onSuccess:async(r,e,i)=>{await k(n,s,r.id),n.setQueryData(s.getEntityACLQueryKey(r.id),r),t!=null&&t.onSuccess&&await t.onSuccess(r,e,i)}})}export{Z as a,ee as b,W as c,j as d,ne as e,ue as f,re as g,te as h,k as i,se as j,N as k,X as l,Y as m,z as u};
//# sourceMappingURL=useEntity-24f7fd17.js.map
